import{$ as ie,h as ce,i as ue,j as e,I as A,A as $e,C as E,a as P,b as M,c as T,f as O,B as f,d as De,e as Ce}from"./CurrentUser.9d68bb13.js";import{r as s}from"./index.40fd2bfc.js";import{u as Ae,F as ve,a as k,b as S,c as w,d as $,e as N,S as Be,f as Fe,g as Ee,h as Pe,P as Me,M as de,i as Te}from"./MarketAssetCard.6610a9ab.js";import{F as Oe,D as Ie,b as Le,f as Je,g as me}from"./common.f8b00d54.js";function Ge(){const x=Ae({defaultValues:{account:""}}),[o,he]=s.useState();s.useEffect(()=>ie.subscribe(l=>{he(l)}),[ie]);const[Q,be]=s.useState([]);s.useEffect(()=>ce.subscribe(l=>{be(l)}),[ce]);const[I,L]=s.useState(""),[c,p]=s.useState(""),[_,W]=s.useState(),[m,fe]=s.useState();s.useEffect(()=>ue.subscribe(l=>{fe(l)}),[ue]),s.useEffect(()=>{async function t(){if(window.location.search){console.log("Parsing url params");const l=new URLSearchParams(window.location.search),n=Object.fromEntries(l.entries()),r=n&&n.pool?n.pool:null;if(!r||!r.length){console.log("No pool parameter found"),p("1.19.0");return}if(r&!r.includes("1.9.")){console.log("Invalid pool parameters"),p("1.19.0");return}if(!m.map(b=>b.id).includes(r)){console.log("Replacing unknown pool with first pool in list"),p("1.19.0");return}p(r)}}m&&m.length&&t()},[m]),s.useEffect(()=>{async function t(){const l=await fetch(`http://localhost:8080/cache/poolAssets/${o.chain}`,{method:"GET"});if(!l.ok){console.log({error:new Error(`${response.status} ${response.statusText}`),msg:"Couldn't generate deeplink."});return}const n=await l.json();n&&W(n)}o&&o.chain&&t()},[o]);const[d,v]=s.useState(0),[D,J]=s.useState(0),[u,R]=s.useState(),[a,B]=s.useState(""),[i,F]=s.useState("");s.useEffect(()=>{if(m&&c&&_){const t=m.find(r=>r.id===c);R(t);const l=_.find(r=>r.id===t.asset_a_id),n=_.find(r=>r.id===t.asset_b_id);B(l),F(n),v(1)}},[c,_]);const[xe,pe]=s.useState(null),[je,ge]=s.useState(null);s.useEffect(()=>{async function t(l,n,r,h){const b=await fetch(`http://localhost:8080/cache/dynamic/${l}/${r}`,{method:"GET"});if(!b.ok){console.log(`Failed to fetch ${n} dynamic data`);return}const j=await b.json();j&&j.result&&(console.log(`Fetched ${n}'s dynamic data`),h(j.result))}o&&a&&i&&(t(o.chain,a.symbol,a.id.replace("1.3.","2.3."),pe),t(o.chain,i.symbol,i.id.replace("1.3.","2.3."),ge))},[o,a,i,u]);const[U,Ne]=s.useState();s.useEffect(()=>{async function t(l,n){const r=await fetch(`http://localhost:8080/api/getAccountBalances/${l}/${n}`,{method:"GET"});if(!r.ok){console.log("Failed to retrieve user balances");return}const h=await r.json();h&&h.result&&(console.log("Fetched user balances"),Ne(h.result))}o&&a&&i&&t(o.chain,o.id)},[o,a,i]),s.useEffect(()=>{if(a&&i&&u){let t=function(){if(y===0)return 0;if(y>0)return Math.min(Number(ne),Math.ceil(Number(d)*Number(h)*(Number(y)/1e4)))},l=function(){if(K===0)return 0;if(K>0)return Math.min(Number(re),Math.ceil(Number(d)*Number(j)*(Number(K)/1e4)))},n=function(){return typeof C>"u"&&y>0?Number(y)/1e4:typeof C>"u"&&y===0?0:Number(C)/1e4};console.log("Calculating the amount the user can buy");let r=Number(u.balance_a),h=Number(10**a.precision),b=Number(u.balance_b),j=Number(10**i.precision);const y=a.market_fee_percent,K=i.market_fee_percent,ne=a.max_market_fee,re=i.max_market_fee,C=u.taker_fee_percent;let oe=Number(n()),Y;if(a.id===u.asset_a_id){let g=Number(b)-Math.ceil(Number(b)*Number(r)/(Number(r)+(Number(d)*Number(h)-Number(t())))),H=Number(g)*Number(C)/1e4;Y=(Number(g)-Math.floor(Number(H))-Math.ceil(Math.min(Number(re),Math.ceil(Number(g)*Number(oe)))))/Number(j)}else{let g=Number(r)-Math.ceil(Number(r)*Number(b)/(Number(b)+(Number(d)*Number(j)-Number(l())))),H=Number(g)*Number(C)/1e4;Y=(Number(g)-Math.floor(Number(H))-Math.ceil(Math.min(Number(ne),Math.ceil(Number(g)*Number(oe)))))/Number(h)}J(Y)}},[d,a,i]);const[Z,ee]=s.useState(!1),_e=()=>{Z||(ee(!0),setTimeout(()=>{ee(!1)},1e4))},[q,V]=s.useState(""),[ye,G]=s.useState(),[X,z]=s.useState(!1);s.useEffect(()=>{if(I){async function t(){z(!0);const l=[{account:o.id,pool:c,amount_to_sell:{amount:me(d,a.precision),asset_id:a.id},min_to_receive:{amount:me(D,i.precision),asset_id:i.id},extensions:[]}];G(l);const n=await fetch(`http://localhost:8080/api/deeplink/${o.chain}/liquidity_pool_exchange`,{method:"POST",body:JSON.stringify(l)});if(!n.ok){console.log({error:new Error(`${n.status} ${n.statusText}`),msg:"Couldn't generate deeplink."});return}const r=await n.json();r&&r.result&&r.result.generatedDeepLink&&V(r.result.generatedDeepLink),z(!1)}t()}},[I,a,i]);const[ke,se]=s.useState();s.useEffect(()=>{se(e.jsx(A,{value:D??0,disabled:!0,className:"mb-3"}))},[D]);const[te,ae]=s.useState(!1),[Se,le]=s.useState("default_pool_key");if(s.useEffect(()=>{c&&window.history.replaceState({},"",`?pool=${c}`),le(`pool_key${Date.now()}`)},[c]),!o||!o.id||!o.id.length)return e.jsx($e,{});const we=({index:t,style:l})=>{const n=m[t];return e.jsx(Te,{value:n.id,style:l,children:`${n.id} - ${n.share_asset_symbol} - ${n.asset_a_symbol}:${n.asset_b_symbol}`})};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"container mx-auto mt-5 mb-5",children:[e.jsx("div",{className:"grid grid-cols-1 gap-3",children:e.jsxs(E,{className:"p-2",children:[e.jsxs(P,{children:[e.jsx(M,{children:"Bitshares Liquidity Pool Exchange"}),e.jsx(T,{children:"Easily swap between Bitshares assets using one of these user created liquidity pools."})]}),e.jsxs(O,{children:[m?null:e.jsx("p",{children:"Loading pool data"}),_?null:e.jsx("p",{children:"Loading asset data"}),m&&_?e.jsxs(e.Fragment,{children:[e.jsx(ve,{...x,children:e.jsxs("form",{onSubmit:()=>{L(!0),ae(!0),event.preventDefault()},children:[e.jsx(k,{control:x.control,name:"account",render:({field:t})=>e.jsxs(S,{children:[e.jsx(w,{children:"Account"}),e.jsx($,{children:e.jsx(A,{disabled:!0,placeholder:"Bitshares account (1.2.x)",className:"mb-3 mt-3",value:`${o.username} (${o.id})`})}),e.jsx(N,{})]})}),e.jsx(k,{control:x.control,name:"pool",render:({field:t})=>e.jsxs(S,{children:[e.jsx(w,{children:"Pool"}),e.jsx($,{onValueChange:l=>{p(l)},children:e.jsxs(Be,{children:[e.jsx(Fe,{className:"mb-3",children:e.jsx(Ee,{placeholder:u?`${u.id} - ${u.share_asset_symbol} - ${u.asset_a_symbol}:${u.asset_b_symbol}`:"Select a pool.."})}),e.jsx(Pe,{className:"bg-white",children:e.jsx(Oe,{height:150,itemCount:m.length,itemSize:35,className:"w-full",initialScrollOffset:m.map(l=>l.id).indexOf(c)*35,children:we})})]},Se)}),e.jsx(N,{})]})}),c?e.jsx(e.Fragment,{children:e.jsx(k,{control:x.control,name:"sellAmount",render:({field:t})=>e.jsxs(S,{children:[e.jsx(w,{children:`Amount of ${a?a.symbol:"???"} to sell:`}),e.jsx($,{onChange:l=>{const n=l.target.value;/^[0-9]*\.?[0-9]*$/.test(n)&&v(n)},children:e.jsx(A,{label:`Amount of ${a?a.symbol:"???"} to sell`,value:d,placeholder:d,className:"mb-3"})}),e.jsx(N,{})]})})}):null,d&&u&&u.taker_fee_percent?e.jsx(e.Fragment,{children:e.jsx(k,{control:x.control,name:"marketFee",render:({field:t})=>e.jsxs(S,{children:[e.jsx(w,{children:"Pool fee"}),e.jsx($,{children:e.jsx(A,{disabled:!0,placeholder:"0",className:"mb-3 mt-3",value:(u.taker_fee_percent/1e3*d).toFixed(a.precision)})}),e.jsx(N,{})]})})}):null,u?e.jsx(k,{control:x.control,name:"networkFee",render:({field:t})=>e.jsxs(S,{children:[e.jsx(w,{children:"Network fee"}),e.jsx($,{children:e.jsx(A,{disabled:!0,placeholder:"1 BTS",className:"mb-3 mt-3",value:"1 BTS"})}),o.id===o.referrer?e.jsx(N,{children:"Rebate: 0.8 BTS (vesting)"}):null,e.jsx(N,{})]})}):null,c?e.jsx(e.Fragment,{children:e.jsx(k,{control:x.control,name:"buyAmount",render:({field:t})=>e.jsxs(S,{children:[e.jsx(w,{children:`Amount of ${i?i.symbol:"???"} you'll receive:`}),e.jsx($,{children:ke}),e.jsx(N,{})]})})}):null,!c||!d||!D||X!==!1?e.jsx(f,{className:"mt-5 mb-3",variant:"outline",disabled:!0,type:"submit",children:"Submit"}):e.jsx(f,{className:"mt-5 mb-3",variant:"outline",type:"submit",children:"Submit"})]})}),te&&I&&q&&e.jsx(Ie,{open:te,onOpenChange:t=>{t||(L(""),V(""),G(),p(""),v(0),J(0),R(),B(""),F(""),le(`pool_key${Date.now()}`)),ae(t)},children:e.jsx(Le,{className:"sm:max-w-[425px] bg-white",children:e.jsxs(e.Fragment,{children:[e.jsxs("h1",{className:"scroll-m-20 text-2xl font-extrabold tracking-tight",children:["Exchanging ",d," ",a.symbol," for"," ",D," ",i.symbol]}),e.jsx("h3",{className:"scroll-m-20 text-1xl font-semibold tracking-tight mb-3 mt-1",children:"Your requested Bitshares pool exchange operation is ready!"}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsx(f,{color:"gray",className:"w-full",onClick:()=>{Je(JSON.stringify(ye))},variant:"outline",children:"Copy operation JSON"}),Z?e.jsx(f,{variant:"outline",disabled:!0,children:"Downloading..."}):e.jsx("a",{href:`data:text/json;charset=utf-8,${q}`,download:"pool_exchange.json",target:"_blank",rel:"noreferrer",onClick:_e,children:e.jsx(f,{variant:"outline",className:"w-full",children:"Download Beet operation JSON"})}),e.jsx("a",{href:`rawbeet://api?chain=BTS&request=${q}`,children:e.jsx(f,{variant:"outline",className:"w-full",children:"Trigger raw Beet deeplink"})})]})]})})}),c&&!X?e.jsx(f,{variant:"outline",mt:"xl",onClick:()=>{const t=a;B(i),F(t)},children:"Swap buy/sell"}):null,c&&X?e.jsx(f,{variant:"outline",mt:"xl",disabled:!0,children:"Swap buy/sell"}):null,c?e.jsx("a",{href:`https://blocksights.info/#/pools/${c}${o.chain!=="bitshares"?"?network=testnet":""}`,target:"_blank",children:e.jsx(f,{variant:"outline",className:"ml-2",children:"Blocksights pool explorer"})}):null]}):null]})]})}),a&&i?e.jsx(Me,{assetA:a.symbol,assetAData:a,assetB:i.symbol,assetBData:i}):null,e.jsxs("div",{className:"grid grid-cols-2 gap-5 mt-5",children:[e.jsx("div",{className:"grid grid-cols-1 gap-3",children:U&&c?e.jsxs(e.Fragment,{children:[e.jsx(de,{asset:i.symbol,assetData:i,assetDetails:je,marketSearch:Q,chain:o.chain,usrBalances:U,type:"buy"}),e.jsx(de,{asset:a.symbol,assetData:a,assetDetails:xe,marketSearch:Q,chain:o.chain,usrBalances:U,type:"sell"})]}):null}),e.jsx("div",{className:"grid grid-cols-1 gap-3",children:c?e.jsxs(e.Fragment,{children:[e.jsx("a",{href:`/dex/index.html?market=${a.symbol}_${i.symbol}`,children:e.jsxs(E,{children:[e.jsxs(P,{className:"pb-2 pt-4",children:[e.jsx(M,{children:"Trade on the Dex instead?"}),e.jsxs(T,{className:"text-lg",children:["Market: ",a.symbol,"/",i.symbol]})]}),e.jsx(O,{className:"text-sm pb-2",children:"You can manually create limit orders for trading pairs of your choice on the Bitshares DEX"})]})}),e.jsx("a",{href:`/dex/index.html?market=${u?.share_asset_symbol}_${a.symbol}`,children:e.jsxs(E,{children:[e.jsxs(P,{className:"pb-2 pt-4",children:[e.jsx(M,{children:"Purchase stake in this pool?"}),e.jsxs(T,{className:"text-lg",children:["Share asset: ",u?.share_asset_symbol]})]}),e.jsx(O,{className:"text-sm pb-2",children:"Consider earning yield over time by owning a stake in the pool."})]})}),e.jsxs(E,{children:[e.jsxs(P,{className:"pb-2 pt-4",children:[e.jsx(M,{children:"Need to borrow some assets?"}),e.jsxs(T,{className:"text-lg",children:["Borrow ",a.symbol," or ",i.symbol]})]}),e.jsx(O,{className:"text-sm pb-2",children:"Borrow from DEX participants, with user defined rates."})]})]}):null})]})]}),o?e.jsx(De,{usr:o,resetCallback:()=>{Ce(),L(""),p(""),setPools(),W(),v(0),J(0),R(),B(""),F(""),V(""),G(),z(!1),se()}}):null]})}export{Ge as default};
