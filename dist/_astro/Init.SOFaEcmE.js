import{r as x}from"./index.sXsv9c-e.js";import{m,o as Te,b as ve,e as Y,d as q,s as H,a as z}from"./utils.7znXe2qs.js";import{$ as Q,f as W,g as pe,s as M}from"./users.2JVUOKN_.js";let G=0,X=[];function ye(){return G+=1,()=>{if(G-=1,G===0){let e=X;X=[];for(let t of e)t()}}}function Ee(e,t,s){let n=new Set([...t,void 0]);return e.listen((h,c)=>{n.has(c)&&s(h,c)})}const L=m([]),Z=m([]);function ee(e){return e.map(t=>({id:`1.3.${t.id}`,symbol:t.s,precision:t.p,issuer:`1.2.${t.i}`,market_fee_percent:t.mfp,max_market_fee:t.mmf,max_supply:t.ms}))}function _e(e){const t=L.get();(!t||!t.length)&&L.set(ee(e.bitshares));const s=Z.get();(!s||!s.length)&&Z.set(ee(e.bitshares_testnet))}const R=m([]),te=m([]);function se(e){return e.map(t=>({id:`1.19.${t.id}`,asset_a_id:`1.3.${t.a}`,asset_a_symbol:t.as,asset_b_id:`1.3.${t.b}`,asset_b_symbol:t.bs,share_asset_symbol:t.sa,balance_a:t.ba,balance_b:t.bb,taker_fee_percent:t.tfp}))}function Ce(e){const t=R.get();if(!t||!t.length){const n=se(e.bitshares);R.set(n)}const s=te.get();if(!s||!s.length){const n=se(e.bitshares_testnet);te.set(n)}}const j=m([]),ne=m([]);function we(e){const t=j.get();if(!t||!t.length){const n=e.bitshares;j.set(n)}const s=ne.get();if(!s||!s.length){const n=e.bitshares_testnet;ne.set(n)}}const J=m([]),ae=m([]);function $e(e){const t=J.get();(!t||!t.length)&&J.set(e.bitshares);const s=ae.get();(!s||!s.length)&&ae.set(e.bitshares_testnet)}const fe=m(null),Oe=m(null);function ke(e){fe.set(e.bitshares),Oe.set(e.bitshares_testnet)}const de=m([]),Ae=m([]);function Ke(e){de.set(e.bitshares),Ae.set(e.bitshares_testnet)}let Pe=()=>({emit(e,...t){let s=this.events[e]||[];for(let n=0,h=s.length;n<h;n++)s[n](...t)},events:{},on(e,t){return this.events[e]?.push(t)||(this.events[e]=[t]),()=>{this.events[e]=this.events[e]?.filter(s=>t!==s)}}});const xe=({cache:e=new Map,fetcher:t,...s}={})=>{const n=Pe();let h=!0;le("visibilitychange",()=>{h=!document.hidden,h&&n.emit(oe)}),le("online",()=>n.emit(ie));const c=new Map,l=new Map,b=new Map;let T={};const f=async([a,S],o,r,p)=>{var _;if(!h)return;const i=g=>{o.key===a&&(o.set(g),n.emit(I,a,g,!0))},d=()=>{i({...o.value,...he,promise:b.get(a)})},{dedupeTime:v=4e3,fetcher:$}={...r,...T},y=ue();if(b.has(a)){o.value.loading||d();return}if(!p){const g=e.get(a);g&&o.value.data!==g&&i({data:g,...w});const u=l.get(a);if(u&&u+v>y)return}const K=ye();try{const g=$(...S);l.set(a,y),b.set(a,g),d();const u=await g;e.set(a,u),i({data:u,...w}),l.set(a,ue())}catch(g){(_=r.onError)==null||_.call(r,g),i({data:o.value.data,error:g,...w})}finally{K(),b.delete(a)}},U=(a,{fetcher:S=t,...o}={})=>{const r=m({...w}),p={...s,...o,fetcher:S};r._=be,r.invalidate=()=>{const{key:u}=r;u&&B(u)},r.mutate=u=>{const{key:O}=r;O&&F(O,u)};let _,i,d,v,$,y=[];Te(r,()=>{const u=!_;[$,_]=Ue(a),v=$.subscribe(k=>{if(k){const[C,P]=k;r.key=C,f([C,P],r,p),i=C,d=P}else r.key=i=d=void 0,r.set({...w})});const O=$.get();O&&([i,d]=O,u&&K());const{refetchInterval:V=0,refetchOnFocus:me,refetchOnReconnect:Se}=p,N=()=>{i&&f([i,d],r,p)};V>0&&c.set(a,setInterval(N,V)),me&&y.push(n.on(oe,N)),Se&&y.push(n.on(ie,N)),y.push(n.on(ce,k=>{i&&D(i,k)&&f([i,d],r,p,!0)}),n.on(I,(k,C,P)=>{i&&D(i,k)&&r.value!==C&&r.value.data!==C&&r.set(P?C:{data:C,...w})}))});const K=()=>{i&&d&&f([i,d],r,p)},g=r.listen;return r.listen=u=>{const O=g(u);return u(r.value),K(),O},ve(r,()=>{r.value={...w},_?.(),y.forEach(u=>u()),y=[],v?.(),clearInterval(c.get(a))}),r},A=a=>{e.delete(a),l.delete(a)},E=(a,S)=>{for(const o of e.keys())D(o,a)&&S(o)},B=a=>{E(a,A),n.emit(ce,a)},F=(a,S)=>{E(a,o=>{S===void 0?A(o):e.set(o,S)}),n.emit(I,a,S)};function ge(a){const S=async r=>{var p;const _=T.fetcher??a,i=[];try{o.set({error:void 0,data:void 0,mutate:S,...he});const d=await _({data:r,invalidate:v=>{i.push(v)},getCacheUpdater:(v,$=!0)=>[y=>{F(v,y),$&&i.push(v)},e.get(v)]});return o.setKey("data",d),d}catch(d){(p=s?.onError)==null||p.call(s,d),o.setKey("error",d)}finally{o.setKey("loading",!1),i.forEach(B)}},o=m({mutate:S,...w});return o.mutate=S,o}return[U,ge,{__unsafeOverruleSettings:a=>{console.warn("You should only use __unsafeOverruleSettings in test environment"),T=a},invalidateKeys:B,mutateCache:F}]};function re(e){return typeof e=="string"||typeof e=="number"||e===!0}const Ue=e=>{if(re(e))return[Y([""+e,[e]]),()=>{}];let t=Y(null),s=[];const n=()=>{s.some(c=>c==null||c===!1)?t.set(null):t.set([s.join(""),s])},h=[];for(let c=0;c<e.length;c++){const l=e[c];re(l)?s.push(l):h.push(l.subscribe(b=>{s[c]=Be(l)?l.value&&"data"in l.value?l.key:null:b,n()}))}return n(),[t,()=>h.forEach(c=>c())]};function Be(e){return e._===be}const oe=1,ie=2,ce=3,I=4,le=(e,t)=>{typeof window>"u"||addEventListener(e,t)},D=(e,t)=>Array.isArray(t)?t.includes(e):typeof t=="function"?t(e):e===t,ue=()=>new Date().getTime(),be=Symbol(),he={loading:!0},w={loading:!1};function Fe(e,t={}){let s=x.useCallback(h=>t.keys?Ee(e,t.keys,h):e.listen(h),[t.keys,e]),n=e.get.bind(e);return x.useSyncExternalStore(s,n,n)}const[Ne]=xe({fetcher:async e=>{const t=e?e.split(","):[],s=[t.includes("marketSearch")&&!J.get().length?fetch("http://localhost:8080/cache/marketSearch/bitshares",{method:"GET"}):null,t.includes("assets")&&!L.get().length?fetch("http://localhost:8080/cache/minAssets/bitshares",{method:"GET"}):null,t.includes("pools")&&!R.get().length?fetch("http://localhost:8080/cache/minPools/bitshares",{method:"GET"}):null,t.includes("globalParams")&&!fe.get()?fetch("http://localhost:8080/cache/feeSchedule/bitshares",{method:"GET"}):null,t.includes("offers")&&!j.get().length?fetch("http://localhost:8080/cache/offers/bitshares",{method:"GET"}):null,t.includes("bitAssetData")&&!de.get().length?fetch("http://localhost:8080/cache/bitassets/bitshares",{method:"GET"}):null];return await Promise.all(s)}});async function Le(e,t){const s=x.useMemo(()=>Ne([t.join(",")]),[e]),{data:n,loading:h,error:c}=Fe(s);if(x.useEffect(()=>{async function l(){await Promise.all(n.map(async(b,T)=>{if(!b)return;if(!b.ok){console.log("Failed to fetch data");return}const f=await b.json();if(!f||!f.result){console.log("Failed to fetch data");return}const U=q(H(f.result.bitshares,!0)),A=q(H(f.result.bitshares_testnet,!0)),E={bitshares:JSON.parse(z(U)),bitshares_testnet:JSON.parse(z(A))};switch(T){case 0:$e(E);break;case 1:_e(E);break;case 2:Ce(E);break;case 3:ke(E);break;case 4:we(E);break;case 5:Ke(E);break}}))}n&&!h&&!c&&l()},[n,h,c]),!Q||!Q.get().username){const l=W.get().users,b=W.get().lastAccount,T=l.find(f=>f.chain===e);if(!l||!l.length||!T)pe("null-account","1.2.3","1.2.3","bitshares"),M("null-account","1.2.3","1.2.3","bitshares");else if(b&&b.length){const f=b[0];M(f.username,f.id,f.referrer,f.chain)}else T&&M(T.username,T.id,T.referrer,T.chain)}}export{L as $,Z as a,fe as b,Oe as c,j as d,ne as e,R as f,te as g,J as h,ae as i,de as j,Ae as k,Fe as l,xe as n,Le as u};
