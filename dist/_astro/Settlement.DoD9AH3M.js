import{u as ve,l as _e,j as e,i as $e}from"./utils.bLvbV6bL.js";import{r as a}from"./index.sXsv9c-e.js";import{u as Ae,F as Ce,a as j,b,c as S,d as f,e as g,f as T}from"./form.A0Qkkm5M.js";import{F as De}from"./index.esm.AIjKFR9D.js";import{$ as X,C as Y,a as Z,b as ee,c as se,d as te}from"./users.BctaTsGw.js";import{A as Be,a as ye}from"./avatar.oJrCPQEx.js";import{A as Te}from"./Avatar.yfo8l8eH.js";import{P as w,a as M,b as R}from"./popover.utxwtVSl.js";import{B as Pe}from"./button.Zbz0OamP.js";import{I as d}from"./input.-RC9ozKz.js";import{L as C,D as Oe}from"./DeepLinkDialog.Ifn7l-Kl.js";import{j as ne,k as le,h as ae,i as re,d as ie,e as ce,u as Ee}from"./Init.PDcv3DKJ.js";import"./User.Ij8JWmds.js";import{b as ke,d as Ie}from"./Assets.fmufG_18.js";import{h as F,g as we,d as J}from"./common.u-9orcM8.js";import"./index.zSBU31wW.js";import"./index.QjywInIh.js";import"./index.F5qScCsY.js";import"./dialog.JrXWYe8i.js";import"./index.O1ihjiPW.js";import"./ExternalLink.I0nfYBUQ.js";import"./index.VgUB0jFn.js";function os(s){const{t:l,i18n:n}=ve(_e.get(),{i18n:$e}),t=Ae({defaultValues:{account:""}}),r=a.useSyncExternalStore(X.subscribe,X.get,(()=>!0)),i=a.useSyncExternalStore(ne.subscribe,ne.get,(()=>!0)),c=a.useSyncExternalStore(le.subscribe,le.get,(()=>!0)),o=a.useSyncExternalStore(ae.subscribe,ae.get,(()=>!0)),m=a.useSyncExternalStore(re.subscribe,re.get,(()=>!0)),x=a.useSyncExternalStore(ie.subscribe,ie.get,(()=>!0)),h=a.useSyncExternalStore(ce.subscribe,ce.get,(()=>!0)),u=a.useMemo((()=>r&&r.chain?r.chain:"bitshares"),[r]);Ee(u??"bitshares",["bitAssetData","globalParams","marketSearch"]);const p=a.useMemo((()=>u&&(i||c)?"bitshares"===u?i:c:[]),[i,c,u]),N=a.useMemo((()=>u&&(x||h)?"bitshares"===u?x:h:[]),[x,h,u]),v=a.useMemo((()=>u&&(o||m)?"bitshares"===u?o:m:[]),[o,m,u]),[_,$]=a.useState(),[y,A]=a.useState(),[D,O]=a.useState(),[B,P]=a.useState(0),[I,E]=a.useState(0);a.useEffect((()=>{if(N&&N.length){const e=N.find((e=>45===e[0])),s=N.find((e=>17===e[0])),l=F(e[1].fee,5),n=F(s[1].fee,5);P(l),E(n)}}),[N]);const k=a.useMemo((()=>{if(v&&v.length&&window.location.search){const e=new URLSearchParams(window.location.search),s=Object.fromEntries(e.entries()),l=s&&s.id?s.id:null;return!l||!l.length||l&&!l.includes("1.3.")?void console.log("Invalid parameter"):(v&&v.length?v.map((e=>e.id)):[]).includes(l)?l:void console.log("Invalid parameter")}}),[v]),z=a.useMemo((()=>k&&k.length&&v?v.find((e=>e.id===k)):null),[k,v]),L=a.useMemo((()=>z&&p?p.find((e=>e.assetID===z.id)):null),[z,p]),U=a.useMemo((()=>{if(L&&p)return v.find((e=>e.id===L.collateral))}),[L,p]),q=a.useMemo((()=>{if(y&&y.current_feed&&U&&z)return parseFloat((F(parseInt(y.current_feed.settlement_price.quote.amount),U.p)/F(parseInt(y.current_feed.settlement_price.base.amount),z.p)).toFixed(U.p))}),[y,z,U]),K=a.useMemo((()=>{if(_&&z&&U){return{finalSettlementFund:F(parseInt(y.settlement_fund),U.p),finalSettlementPrice:parseFloat((1/(F(y.settlement_price.quote.amount,U.p)/F(y.settlement_price.base.amount,z.p))).toFixed(z.p))}}}),[y,z,U]),Q=a.useMemo((()=>{if(y&&z&&U){return{_debt:F(parseInt(y.individual_settlement_debt),z.p),_fund:F(parseInt(y.individual_settlement_fund),U.p)}}}),[y,z,U]);a.useEffect((()=>{let e;return L&&L&&r&&r.chain&&(e=ke([r.chain,z.id,L.collateral,L.id]).subscribe((({data:e,error:s,loading:l})=>{e&&!s&&!l&&($(e[0]),O(e[1]),A(e[2]))}))),()=>{e&&e()}}),[z,L,r]);const[V,W]=a.useState();a.useEffect((()=>{let e;return z&&r&&r.chain&&(e=Ie([r.chain,z.id]).subscribe((({data:e,error:s,loading:l})=>{e&&!s&&!l&&W(e)}))),()=>{e&&e()}}),[z,r]);const G=a.useMemo((()=>{if(_){const e=we(_.options.flags);return Object.keys(e).includes("disable_collateral_bidding")}}),[_]),[H,de]=a.useState(0),[oe,me]=a.useState(0),[xe,je]=a.useState(0),[he,ue]=a.useState(0),[pe,be]=a.useState(!1);return e.jsx(e.Fragment,{children:e.jsx("div",{className:"container mx-auto mt-5 mb-5",children:e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs(Y,{children:[e.jsxs(Z,{children:[e.jsx(ee,{children:l("Settlement:smartcoinSettlementFormTitle")}),e.jsx(se,{children:K&&K.finalSettlementFund?l("Settlement:bidOnGlobalSettlementFundsDescription"):l("Settlement:forceSettleAssetsDescription")})]}),e.jsxs(te,{children:[e.jsx(Ce,{...t,children:e.jsxs("form",{onSubmit:e=>{be(!0),e.stopPropagation(),e.preventDefault()},children:[e.jsx(j,{control:t.control,name:"account",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:K&&K.finalSettlementFund?l("Settlement:biddingAccount"):l("Settlement:assetSettlingAccount")}),e.jsx(f,{children:e.jsxs("div",{className:"grid grid-cols-8 mt-4",children:[e.jsx("div",{className:"col-span-1 ml-5",children:r&&r.username?e.jsx(Te,{size:40,name:r.username,extra:"Target",expression:{eye:"normal",mouth:"open"},colors:["#92A1C6","#146A7C","#F0AB3D","#C271B4","#C20D90"]}):e.jsx(Be,{children:e.jsx(ye,{children:"?"})})}),e.jsx("div",{className:"col-span-7",children:e.jsx(d,{disabled:!0,placeholder:"Bitshares account (1.2.x)",className:"mb-3",value:`${r.username} (${r.id})`,readOnly:!0})})]})}),e.jsx(g,{})]})}),e.jsx(j,{control:t.control,name:"selectedAsset",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:selectedAsset")}),e.jsx(f,{children:e.jsx("span",{className:"grid grid-cols-8",children:e.jsx("span",{className:"col-span-6",children:e.jsx(d,{disabled:!0,placeholder:"Bitshares smartcoin (1.3.x)",className:"mb-1",value:`${z?z.s:""} (${z?z.id:""})`,readOnly:!0})})})}),e.jsx(g,{})]})}),e.jsx(j,{control:t.control,name:"currentFeedPrice",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:currentFeedPrice")})," ",e.jsx(f,{children:e.jsx("span",{className:"grid grid-cols-8",children:e.jsx("span",{className:"col-span-6",children:z&&U?e.jsx(d,{disabled:!0,className:"mb-1",value:`${q?(1/q).toFixed(z.p):0} ${z?z.s:""}/${U?U.s:""}`,readOnly:!0}):e.jsx(d,{disabled:!0,className:"mb-1",value:"",readOnly:!0})})})}),e.jsx(g,{})]})}),K&&K.finalSettlementFund?e.jsxs(e.Fragment,{children:[e.jsx(j,{control:t.control,name:"settlementPrice",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:finalSettlementPrice")})," ",e.jsx(f,{children:e.jsx("span",{className:"grid grid-cols-8",children:e.jsx("span",{className:"col-span-6",children:e.jsx(d,{disabled:!0,className:"mb-1",value:`${K.finalSettlementPrice} ${z.s}/${U.s}`,readOnly:!0})})})}),e.jsx(g,{})]})}),e.jsx(j,{control:t.control,name:"fundsAvailable",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:settlementFundsAvailable")})," ",e.jsx(f,{children:e.jsx("span",{className:"grid grid-cols-8",children:e.jsx("span",{className:"col-span-6",children:e.jsx(d,{disabled:!0,className:"mb-1",value:`${K.finalSettlementFund} ${U.s}`,readOnly:!0})})})}),e.jsx(g,{})]})}),e.jsx(j,{control:t.control,name:"fundingRatio1",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:fundingRatio")}),e.jsx(f,{children:e.jsxs("span",{className:"grid grid-cols-8",children:[e.jsx("span",{className:"col-span-2 mb-1",children:e.jsx(d,{disabled:!0,value:`${(1/q/K.finalSettlementPrice*100).toFixed(2)} %`,readOnly:!0})}),e.jsx("span",{className:"col-span-2 text-red-500",children:e.jsx(d,{disabled:!0,value:`-${(100-1/q/K.finalSettlementPrice*100).toFixed(2)}%`,readOnly:!0})})]})}),e.jsx(g,{})]})}),e.jsx(j,{control:t.control,name:"additionalCollateral",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:additionalCollateral")}),e.jsx(T,{children:l("Settlement:additionalCollateralDescription",{asset:z.s})}),e.jsx(f,{children:e.jsxs("span",{className:"grid grid-cols-12",children:[e.jsx("span",{className:"col-span-8",children:e.jsx(d,{placeholder:xe?`${xe} ${U.s}`:`0 ${U.s}`,readOnly:!0,disabled:!0,className:"mb-3"})}),e.jsx("span",{className:"col-span-4 ml-3",children:e.jsxs(w,{children:[e.jsx(M,{children:e.jsx("span",{className:"inline-block border border-grey rounded pl-4 pb-1 pr-4",children:e.jsx(C,{children:l("Settlement:changeAmount")})})}),e.jsxs(R,{children:[e.jsx(C,{children:l("Settlement:provideNewAmount")}),e.jsx(d,{placeholder:xe,className:"mb-2 mt-1",onChange:e=>{const s=e.target.value;s&&s.length&&/^[0-9]*\.?[0-9]*$/.test(s)&&je(parseFloat(s).toFixed(U.p))}})]})]})})]})})]})}),e.jsx(j,{control:t.control,name:"debtCovered",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:totalDebtCoveredByBid")}),e.jsx(T,{children:l("Settlement:totalDebtCoveredByBidDescription")}),e.jsx(f,{children:e.jsxs("span",{className:"grid grid-cols-12",children:[e.jsx("span",{className:"col-span-8",children:e.jsx(d,{placeholder:he?`${he} ${z.s}`:`0 ${z.s}`,readOnly:!0,disabled:!0,className:"mb-3"})}),e.jsx("span",{className:"col-span-4 ml-3",children:e.jsxs(w,{children:[e.jsx(M,{children:e.jsx("span",{className:"inline-block border border-grey rounded pl-4 pb-1 pr-4",children:e.jsx(C,{children:l("Settlement:changeTotal")})})}),e.jsxs(R,{children:[e.jsx(C,{children:l("Settlement:provideNewTotal")}),e.jsx(d,{placeholder:he,className:"mb-2 mt-1",onChange:e=>{const s=e.target.value;s&&s.length&&/^[0-9]*\.?[0-9]*$/.test(s)&&ue(parseFloat(s).toFixed(z.p))}})]})]})})]})})]})})]}):null,Q&&(Q._debt||Q._fund)?e.jsxs(e.Fragment,{children:[e.jsx(j,{control:t.control,name:"isd",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:individualSettlementDebt")})," ",e.jsx(f,{children:e.jsx("span",{className:"grid grid-cols-8",children:e.jsx("span",{className:"col-span-6",children:e.jsx(d,{disabled:!0,className:"mb-1",value:`${Q._debt} ${z.s}`,readOnly:!0})})})}),e.jsx(g,{})]})}),e.jsx(j,{control:t.control,name:"isf",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:individualSettlementFund")})," ",e.jsx(f,{children:e.jsx("span",{className:"grid grid-cols-8",children:e.jsx("span",{className:"col-span-6",children:e.jsx(d,{disabled:!0,className:"mb-1",value:`${Q._fund} ${U.s}`,readOnly:!0})})})}),e.jsx(g,{})]})}),e.jsx(j,{control:t.control,name:"fundingRatio2",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:fundingRatio")}),e.jsx(f,{children:e.jsxs("span",{className:"grid grid-cols-8",children:[e.jsx("span",{className:"col-span-2 mb-1",children:e.jsx(d,{disabled:!0,value:`${(Q._debt*q/Q._fund*100).toFixed(2)} %`,readOnly:!0})}),e.jsx("span",{className:"col-span-2 text-red-500",children:e.jsx(d,{disabled:!0,value:`-${(100-Q._debt*q/Q._fund*100).toFixed(2)}%`,readOnly:!0})})]})}),e.jsx(g,{})]})}),e.jsx(j,{control:t.control,name:"ForceSettleAmount",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:forceSettleAmount")}),e.jsx(T,{children:l("Settlement:forceSettleAmountDescription")}),e.jsx(f,{children:e.jsxs("span",{className:"grid grid-cols-12",children:[e.jsx("span",{className:"col-span-8",children:e.jsx(d,{placeholder:H?`${H} ${z.s}`:`0 ${z.s}`,readOnly:!0,disabled:!0,className:"mb-3"})}),e.jsx("span",{className:"col-span-4 ml-3",children:e.jsxs(w,{children:[e.jsx(M,{children:e.jsx("span",{className:"inline-block border border-grey rounded pl-4 pb-1 pr-4",children:e.jsx(C,{children:l("Settlement:changeAmount")})})}),e.jsxs(R,{children:[e.jsx(C,{children:l("Settlement:provideNewForceSettleAmount")}),e.jsx(d,{placeholder:H,className:"mb-2 mt-1",onChange:e=>{const s=e.target.value;if(s&&s.length&&/^[0-9]*\.?[0-9]*$/.test(s)){de(parseFloat(s).toFixed(z.p));const e=parseFloat((Q._debt/Q._fund*s).toFixed(U.p));me(e)}}})]})]})})]})}),H&&Q._debt&&H>Q._debt?e.jsx(g,{children:l("Settlement:forceSettleAmountExceedsDebt")}):null]})}),e.jsx(j,{control:t.control,name:"totalReceiving",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:totalAmountReceive")}),e.jsx(T,{children:l("Settlement:totalAmountReceiveDescription",{asset:z.s})}),e.jsx(f,{children:e.jsxs("span",{className:"grid grid-cols-12",children:[e.jsx("span",{className:"col-span-8",children:e.jsx(d,{placeholder:oe?`${oe} ${U.s}`:`0 ${U.s}`,readOnly:!0,disabled:!0,className:"mb-1"})}),e.jsx("span",{className:"col-span-4 ml-3",children:e.jsxs(w,{children:[e.jsx(M,{children:e.jsx("span",{className:"inline-block border border-grey rounded pl-4 pb-1 pr-4",children:e.jsx(C,{children:l("Settlement:changeTotal")})})}),e.jsxs(R,{children:[e.jsx(C,{children:l("Settlement:provideNewTotalAmount")}),e.jsx(d,{placeholder:oe,className:"mb-2 mt-1",onChange:e=>{const s=e.target.value;s&&s.length&&/^[0-9]*\.?[0-9]*$/.test(s)&&(me(parseFloat(s).toFixed(U.p)),de((s/q).toFixed(z.p)))}})]})]})})]})}),e.jsx(g,{children:l("Settlement:payingPremium",{premium:(100-Q._debt*q/Q._fund*100).toFixed(2)})})]})})]}):null,e.jsx(j,{control:t.control,name:"fee",render:({field:s})=>e.jsxs(b,{children:[e.jsx(S,{children:l("Settlement:networkFee")}),e.jsx(T,{children:l("Settlement:operation",{operation:K&&K.finalSettlementFund?45:17})}),e.jsx(f,{children:e.jsx("span",{className:"grid grid-cols-8",children:e.jsx("span",{className:"col-span-6",children:e.jsx(d,{disabled:!0,className:"mb-1",value:`${K&&K.finalSettlementFund?B:I} ${"Bitshares"===r.chain?"BTS":"TEST"}`,readOnly:!0})})})}),e.jsx(g,{})]})}),y&&y.options.extensions.force_settle_fee_percent?e.jsx(g,{children:l("Settlement:additionalForceSettlementFee",{fee:y.options.extensions.force_settle_fee_percent/100})}):null,e.jsx(Pe,{className:"mt-5 mb-3",type:"submit",children:l("Settlement:submit")}),G?e.jsx(g,{children:l("Settlement:collateralBiddingDisabled")}):null]})}),K&&(!K||K.finalSettlementFund)||Q&&(!Q||Q._debt&&Q._fund)?null:"No settlement funds available"]})]}),V&&V.length?e.jsxs(Y,{children:[e.jsxs(Z,{children:[e.jsx(ee,{children:l("Settlement:existingCollateralBids")}),e.jsx(se,{children:l("Settlement:existingCollateralBidsDescription")})]}),e.jsxs(te,{children:[e.jsxs("div",{className:"grid grid-cols-5",children:[e.jsx("div",{className:"col-span-1",children:l("Settlement:bidder")}),e.jsx("div",{className:"col-span-1",children:l("Settlement:collateral")}),e.jsx("div",{className:"col-span-1",children:l("Settlement:debt")}),e.jsx("div",{className:"col-span-1",children:l("Settlement:bidPrice")}),e.jsx("div",{className:"col-span-1",children:l("Settlement:ratio")})]}),e.jsx(De,{height:500,itemCount:V.length,itemSize:225,className:"w-full",children:({index:s,style:l})=>{const n=V[s],t=F(n.bid.base.amount,U.p),a=F(n.bid.quote.amount,z.p),r=parseFloat((t/a).toFixed(U.p)),i=parseFloat((1/q/r*100).toFixed(2));return e.jsxs("div",{className:"grid grid-cols-4 text-sm",style:l,children:[e.jsx("div",{className:"col-span-1",children:n.bidder}),e.jsx("div",{className:"col-span-1",children:t}),e.jsx("div",{className:"col-span-1",children:a}),e.jsx("div",{className:"col-span-1",children:r}),e.jsx("div",{className:"col-span-1",children:i})]})}})]})]}):null,pe?e.jsx(Oe,{operationName:K&&K.finalSettlementFund?"bid_collateral":"asset_settle",username:r.username,usrChain:r.chain,userID:r.id,dismissCallback:be,headerText:K&&K.finalSettlementFund?l("Settlement:biddingOnDebt",{asset:z.s,collateral:U.s}):l("Settlement:settlingFor",{forceSettleAmount:H,asset:z.s,totalReceiving:oe,collateral:U.s}),trxJSON:[K&&K.finalSettlementFund?{bidder:r.id,additional_collateral:{amount:J(xe,U.p),asset_id:U.id},debt_covered:{amount:J(he,z.p),asset_id:z.id},extensions:[]}:{account:r.id,amount:{amount:J(H,z.p),asset_id:z.id},extensions:[]}]},K&&K.finalSettlementFund?`bidCollateral${U.s}Debt${z.s}`:`Settling${H}${z.s}for${oe}${U.s}`):null]})})})}export{os as default};