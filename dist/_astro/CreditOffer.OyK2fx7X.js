import{u as Me,l as ke,j as e,i as Ee}from"./utils.bLvbV6bL.js";import{r as l}from"./index.sXsv9c-e.js";import{u as Pe,F as Re,a as f,b as x,c as h,d as j,f as C,e as O}from"./form.A0Qkkm5M.js";import{F as Ie}from"./index.esm.AIjKFR9D.js";import{$ as ae,C as K,a as Q,b as W,c as ie,d as X,e as le}from"./users.BctaTsGw.js";import{S as oe,a as ce,b as de,c as me,d as I}from"./select.J8Ev59Dt.js";import{A,a as $}from"./avatar.oJrCPQEx.js";import{B as Z}from"./button.Zbz0OamP.js";import{I as y}from"./input.-RC9ozKz.js";import{h as v,d as ue}from"./common.u-9orcM8.js";import{$ as fe,a as xe,d as he,e as je,b as Ce,c as pe,u as qe}from"./Init.PDcv3DKJ.js";import{c as Ve}from"./User.Ij8JWmds.js";import{D as Ue}from"./DeepLinkDialog.Ifn7l-Kl.js";import{E as He}from"./ExternalLink.I0nfYBUQ.js";import{A as be}from"./Avatar.yfo8l8eH.js";import"./index.zSBU31wW.js";import"./index.QjywInIh.js";import"./dialog.JrXWYe8i.js";import"./index.F5qScCsY.js";import"./index.f2GGseSc.js";import"./index.VgUB0jFn.js";import"./index.O1ihjiPW.js";import"./index.1Sp87CHV.js";function Le(ee){var r=new Date(ee),re=new Date,d=r-re,c=Math.round(d/1e3/60/60);return c}function xr(ee){const{t:r,i18n:re}=Me(ke.get(),{i18n:Ee}),d=Pe({defaultValues:{account:""}}),c=l.useSyncExternalStore(ae.subscribe,ae.get,()=>!0),q=l.useSyncExternalStore(fe.subscribe,fe.get,()=>!0),V=l.useSyncExternalStore(xe.subscribe,xe.get,()=>!0),U=l.useSyncExternalStore(he.subscribe,he.get,()=>!0),H=l.useSyncExternalStore(je.subscribe,je.get,()=>!0),L=l.useSyncExternalStore(Ce.subscribe,Ce.get,()=>!0),z=l.useSyncExternalStore(pe.subscribe,pe.get,()=>!0),p=l.useMemo(()=>c&&c.chain?c.chain:"bitshares",[c]);qe(p??"bitshares",["assets","globalParams","offers"]);const w=l.useMemo(()=>p&&(q||V)?p==="bitshares"?q:V:[],[q,V,p]),E=l.useMemo(()=>p&&(U||H)?p==="bitshares"?U:H:[],[U,H,p]),P=l.useMemo(()=>p&&(L||z)?p==="bitshares"?L:z:[],[L,z,p]),[se,ge]=l.useState(0);l.useEffect(()=>{if(E&&E.length){const t=E.find(o=>o[0]===72),a=v(t[1].fee,5);ge(a)}},[E]);const[te,ne]=l.useState(!1),[i,ye]=l.useState(null),[s,_e]=l.useState(null);l.useEffect(()=>{async function t(){const a=new URLSearchParams(window.location.search),m=Object.fromEntries(a.entries()).id;if(m){const g=P.find(k=>k.id===m);return g||null}else return console.log("Credit offer parameter not found"),null}P&&P.length&&t().then(a=>{if(!a){ne(!0);return}const o=w.find(m=>m.id===a.asset_type);ne(!1),ye(o),_e(a)})},[P]);const[Y,Oe]=l.useState(),[F,ve]=l.useState([]);l.useEffect(()=>{let t;return c&&c.id&&(t=Ve([c.chain,c.id]).subscribe(({data:o,error:m,loading:g})=>{o&&!m&&!g&&(ve(o.map(k=>k.asset_id)),Oe(o))})),()=>{t&&t()}},[c]);const[b,we]=l.useState(null),D=l.useMemo(()=>s&&s.acceptable_collateral?s.acceptable_collateral.map(t=>t[0]).map(t=>w.find(o=>o.id===t)):[],[s,w]),Ne=({index:t,style:a})=>{const o=D[t];return e.jsx(I,{value:o.id,style:a,children:`${o.symbol} (${o.id})`})},S=l.useMemo(()=>s&&i?v(s.current_balance,i.precision):0,[s,i]),B=l.useMemo(()=>s&&i?v(s.min_deal_amount,i.precision):1,[s,i]),[J,R]=l.useState(B??1),[N,Se]=l.useState(0),[u,T]=l.useState();l.useEffect(()=>{const t=setTimeout(()=>{Se(J)},1e3);return()=>clearTimeout(t)},[J]),l.useEffect(()=>{if(!S){T(0);return}if(N)if(N>S)T(S),R(S);else if(N<B)T(B),R(B);else if(N.toString().split(".").length>1&&N.toString().split(".")[1].length>i.precision){const t=parseFloat(N).toFixed(i.precision);T(t),R(t)}else T(N)},[N,S]);const n=l.useMemo(()=>{if(b&&F&&w&&Y){const t=w.find(o=>o.id===b),a=Y.find(o=>o.asset_id===b);return{amount:a?v(a.amount,t.precision):0,holding:F.includes(b),symbol:t.symbol,precision:t.precision,id:t.id,isBitasset:!!t.bitasset_data_id}}},[b,F,w,Y]),Ae=l.useMemo(()=>{if(s){let t=s.max_duration_seconds/3600,a=new Date;a.setHours(a.getHours()+t);let o=`${a.getDate()}/${a.getMonth()+1}/${a.getFullYear()}`;return t>24?`${Math.floor(t/24)} days (due by ${o})`:`${t.toFixed(t<1?2:0)} hours (due by ${o})`}},[s]),$e=l.useMemo(()=>{if(s){const t=Le(s.auto_disable_time);let a=new Date(s.auto_disable_time),o=`${a.getDate()}/${a.getMonth()+1}/${a.getFullYear()}`;return t>24?`${Math.floor(t/24)} days (on ${o})`:`${t.toFixed(t<1?2:0)} hours (on ${o})`}},[s]),M=l.useMemo(()=>{if(u&&n&&s){let t=0;const a=s.acceptable_collateral.find(g=>g[0]===n.id),o=a[1].base,m=a[1].quote;if(m.asset_id===n.id){const g=v(m.amount,n.precision)/v(o.amount,w.find(k=>k.id===o.asset_id).precision);t+=u*g}return t.toFixed(n.precision)}},[u,n,s]),Fe=l.useMemo(()=>{if(u&&n&&s){const t=s.acceptable_collateral.find(m=>m[0]===n.id),a=t[1].base,o=t[1].quote;if(o.asset_id===n.id)return v(o.amount,n.precision)/v(a.amount,w.find(g=>g.id===a.asset_id).precision)}},[u,n,s]),[De,G]=l.useState(!1),[_,Be]=l.useState(),Te=l.useMemo(()=>{if(_){if(_==="no_auto_repayment")return 0;if(_==="only_full_repayment")return 1;if(_==="allow_partial_repayment")return 2}},[_]);return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"container mx-auto mt-5 mb-5",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[te?e.jsxs(K,{children:[e.jsxs(Q,{className:"pb-1 mb-3 mt-3",children:[e.jsx(W,{children:r("CreditOffer:errorCard.title")}),e.jsxs(ie,{className:"pt-2",children:[r("CreditOffer:errorCard.description1"),e.jsx("br",{}),r("CreditOffer:errorCard.description2")]})]}),e.jsx(X,{children:e.jsx("a",{href:"/offers/index.html",children:e.jsx(Z,{variant:"",className:"h-6",children:r("CreditOffer:errorCard.buttonLabel")})})})]}):null,te?null:e.jsxs(K,{children:[e.jsxs(Q,{className:"pb-1",children:[e.jsx(W,{children:s?r("CreditOffer:offerCardHeader.viewingOffer",{id:s.id,owner_name:s.owner_name??"?",owner_account:s.owner_account}):r("CreditOffer:offerCardHeader.loadingOfferTerms")}),e.jsxs(ie,{children:[r("CreditOffer:offerCardHeader.offerDescription1"),e.jsx("br",{}),r("CreditOffer:offerCardHeader.offerDescription2")]})]}),e.jsx(X,{children:e.jsx("div",{className:"grid grid-cols-1 gap-2 mt-3",children:e.jsx("div",{className:"col-span-1",children:e.jsx(Re,{...d,children:e.jsxs("form",{onSubmit:()=>{G(!0),event.preventDefault()},children:[e.jsx(f,{control:d.control,name:"borrowerAccount",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:r("CreditOffer:cardContent.borrowingAccount")}),e.jsx(j,{children:e.jsxs("div",{className:"grid grid-cols-8 mt-4",children:[e.jsx("div",{className:"col-span-1 ml-5",children:c&&c.username?e.jsx(be,{size:40,name:c.username,extra:"Target",expression:{eye:"normal",mouth:"open"},colors:["#92A1C6","#146A7C","#F0AB3D","#C271B4","#C20D90"]}):e.jsx(A,{children:e.jsx($,{children:"?"})})}),e.jsx("div",{className:"col-span-7",children:e.jsx(y,{disabled:!0,placeholder:"Bitshares account (1.2.x)",className:"mb-1 mt-1",value:c?`${c.username} (${c.id})`:"",readOnly:!0})})]})}),e.jsx(C,{children:r("CreditOffer:cardContent.broadcastDescription")}),e.jsx(O,{})]})}),e.jsx(f,{control:d.control,name:"lenderAccount",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-2 mt-4",children:[e.jsx("div",{className:"col-span-1",children:r("CreditOffer:cardContent.lendingAccount")}),e.jsx("div",{className:"col-span-1 text-right",children:s?e.jsx(He,{classnamecontents:"text-blue-500",type:"text",text:r("CreditOffer:cardContent.viewAccount",{owner_name:s.owner_name}),hyperlink:`https://blocksights.info/#/accounts/${s.owner_name}`}):null})]})}),e.jsx(j,{children:e.jsxs("div",{className:"grid grid-cols-8 mt-4",children:[e.jsx("div",{className:"col-span-1 ml-5",children:s&&s.owner_name?e.jsx(be,{size:40,name:s.owner_name,extra:"Target",expression:{eye:"normal",mouth:"open"},colors:["#92A1C6","#146A7C","#F0AB3D","#C271B4","#C20D90"]}):e.jsx(A,{children:e.jsx($,{children:"?"})})}),e.jsx("div",{className:"col-span-7",children:e.jsx(y,{disabled:!0,placeholder:"Bitshares account (1.2.x)",className:"mb-1 mt-1",value:s?`${s.owner_name} (${s.owner_account})`:"",readOnly:!0})})]})}),e.jsx(C,{children:r("CreditOffer:cardContent.borrowingDescription",{symbol:i?.symbol})}),e.jsx(O,{})]})}),e.jsx(f,{control:d.control,name:"amountAvailable",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:i&&s?r("CreditOffer:cardContent.availableAmount",{symbol:i.symbol,asset_type:s.asset_type}):r("CreditOffer:cardContent.loading")}),e.jsx(j,{children:e.jsxs("div",{className:"grid grid-cols-8 mt-4",children:[e.jsx("div",{className:"col-span-1 ml-5",children:i?e.jsx(A,{children:e.jsx($,{children:e.jsx("div",{className:"text-sm",children:i.bitasset_data_id?"MPA":"UIA"})})}):e.jsx(A,{children:e.jsx($,{children:"?"})})}),e.jsx("div",{className:"col-span-7",children:e.jsx(y,{disabled:!0,placeholder:"Bitshares account (1.2.x)",className:"mb-1 mt-1",value:s&&i?`${v(s.current_balance,i.precision)} ${i.symbol}`:r("CreditOffer:cardContent.loading"),readOnly:!0})})]})}),e.jsx(C,{children:r("CreditOffer:cardContent.offerDescription",{owner_name:s?.owner_name,symbol:i?.symbol})})]})}),e.jsx(f,{control:d.control,name:"backingCollateral",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:e.jsx("div",{className:"grid grid-cols-2 mt-3",children:e.jsx("div",{className:"mt-1",children:r("CreditOffer:cardContent.backingCollateral")})})}),e.jsx(j,{children:e.jsxs("div",{className:"grid grid-cols-8",children:[e.jsx("div",{className:"col-span-1 ml-5 mt-1",children:i?e.jsx(A,{children:e.jsx($,{children:e.jsxs("div",{className:"text-sm",children:[n?null:"?",n&&n.isBitasset?"MPA":null,n&&!n.isBitasset?"UIA":null]})})}):e.jsx(A,{children:e.jsx($,{children:"?"})})}),e.jsx("div",{className:"col-span-7 mt-2",children:e.jsxs(oe,{onValueChange:a=>{we(a)},children:[e.jsx(ce,{className:"mb-1",children:e.jsx(de,{placeholder:n?`${n.symbol} (${n.id})`:r("CreditOffer:cardContent.selectCollateral")})}),e.jsx(me,{className:"bg-white",children:D&&D.length?e.jsx(Ie,{height:100,itemCount:D.length,itemSize:35,className:"w-full",initialScrollOffset:b?D.map(a=>a.id).indexOf(b.id)*35:0,children:Ne}):null})]})})]})}),e.jsx(C,{children:n?r("CreditOffer:cardContent.borrowDescription2",{price:Fe,base:i?.symbol,quote:n.symbol}):r("CreditOffer:cardContent.borrowDescription",{symbol:i?.symbol,owner_name:s?.owner_name})}),F&&b&&!F.includes(b)?e.jsx(O,{children:r("CreditOffer:cardContent.noCollateralMessage")}):null]})}),e.jsx(f,{control:d.control,name:"borrowAmount",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-5",children:[e.jsx("div",{className:"col-span-1",children:r("CreditOffer:cardContent.borrowAmount",{symbol:i?i.symbol:"?"})}),e.jsx("div",{className:"col-span-1 text-right",children:r("CreditOffer:cardContent.availableAmountRange",{minAmount:B??"?",availableAmount:S??"?",symbol:i?.symbol})})]})}),S?e.jsx(j,{onChange:a=>{const o=a.target.value;/^[0-9]*\.?[0-9]*$/.test(o)&&R(o)},children:e.jsx(y,{value:J,className:"mb-3"})}):e.jsx(j,{children:e.jsx(y,{disabled:!0,value:0,className:"mb-3",readOnly:!0})}),e.jsx(C,{children:r("CreditOffer:cardContent.inputBorrowAmount",{symbol:i?.symbol,owner_name:s?.owner_name})}),e.jsx(O,{})]})}),e.jsx(f,{control:d.control,name:"repayMethod",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:e.jsx("div",{className:"grid grid-cols-2 mt-3",children:e.jsx("div",{className:"mt-1",children:r("CreditOffer:cardContent.repayMethod")})})}),e.jsx(j,{children:e.jsxs(oe,{onValueChange:a=>{Be(a)},children:[e.jsx(ce,{className:"mb-1",children:e.jsx(de,{placeholder:r("CreditOffer:cardContent.selectRepayMethod")})}),e.jsxs(me,{className:"bg-white",children:[e.jsx(I,{value:"no_auto_repayment",children:r("CreditOffer:cardContent.noAutoRepayment")}),e.jsx(I,{value:"only_full_repayment",children:r("CreditOffer:cardContent.onlyFullRepayment")}),e.jsx(I,{value:"allow_partial_repayment",children:r("CreditOffer:cardContent.allowPartialRepayment")})]})]})}),e.jsx(C,{children:r("CreditOffer:cardContent.selectRepaymentMethod")}),_?e.jsxs(O,{children:[_==="no_auto_repayment"?r("CreditOffer:cardContent.noAutoRepaymentMessage"):null,_==="only_full_repayment"?r("CreditOffer:cardContent.onlyFullRepaymentMessage"):null,_==="allow_partial_repayment"?r("CreditOffer:cardContent.allowPartialRepaymentMessage"):null]}):null]})}),b?e.jsx(f,{control:d.control,name:"requiredCollateralAmount",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-5",children:[e.jsx("div",{className:"col-span-1",children:r("CreditOffer:cardContent.requiredCollateral")}),e.jsx("div",{className:"col-span-1 text-right",children:n?r("CreditOffer:cardContent.currentBalance",{amount:n.amount,symbol:n.symbol}):r("CreditOffer:cardContent.loadingBalance")})]})}),e.jsx(j,{children:e.jsx(y,{disabled:!0,value:`${M??"0"} ${n?n.symbol:""}`,className:"mb-3",readOnly:!0})}),e.jsx(C,{children:u&&i?r("CreditOffer:cardContent.collateralNeeded",{borrowAmount:u??"",symbol:i?i.symbol:""}):r("CreditOffer:cardContent.enterValidBorrowAmount")}),n&&n.holding&&n.amount<M?e.jsx(O,{children:r("CreditOffer:cardContent.insufficientBalance",{symbol:n.symbol,requiredMore:(M-n.amount).toFixed(n.precision)})}):null,n&&!n.holding?e.jsx(O,{children:r("CreditOffer:cardContent.noAssetHeld")}):null]})}):null,e.jsx(f,{control:d.control,name:"repayPeriod",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:e.jsx("div",{className:"grid grid-cols-2 gap-1 mt-5",children:e.jsx("div",{className:"col-span-1",children:r("CreditOffer:cardContent.repayPeriod")})})}),e.jsx(j,{children:e.jsx(y,{disabled:!0,value:Ae??r("CreditOffer:cardContent.loading"),className:"mb-3",readOnly:!0})}),e.jsx(C,{children:r("CreditOffer:cardContent.repayPeriodDescription")})]})}),e.jsx(f,{control:d.control,name:"offerValidity",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:e.jsx("div",{className:"grid grid-cols-2 gap-1 mt-5",children:e.jsx("div",{className:"col-span-1",children:r("CreditOffer:cardContent.offerExpiry")})})}),e.jsx(j,{children:e.jsx(y,{disabled:!0,value:$e??r("CreditOffer:cardContent.loading"),className:"mb-3",readOnly:!0})}),e.jsx(C,{children:r("CreditOffer:cardContent.offerExpiryDescription")})]})}),e.jsx(f,{control:d.control,name:"estimatedFee",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-1 mt-5",children:[e.jsx("div",{className:"col-span-1",children:r("CreditOffer:cardContent.estimatedFee")}),e.jsx("div",{className:"col-span-1 text-right",children:s?r("CreditOffer:cardContent.borrowFeeRate",{feeRate:s.fee_rate/1e4}):r("CreditOffer:cardContent.loadingFee")})]})}),e.jsx(j,{children:e.jsx(y,{disabled:!0,value:u?r("CreditOffer:cardContent.feeAmount",{feeAmount:u*.01,symbol:i?i.symbol:"?"}):r("CreditOffer:cardContent.zeroFee",{symbol:i?i.symbol:"?"}),className:"mb-3",readOnly:!0})}),e.jsx(C,{children:r("CreditOffer:cardContent.feeDescription",{symbol:i?i.symbol:"?",owner_name:s?s.owner_name:"?"})}),e.jsx(O,{})]})}),e.jsx(f,{control:d.control,disabled:!0,name:"fee",render:({field:t})=>e.jsxs(x,{children:[e.jsx(h,{children:r("CreditOffer:cardContent.networkFee")}),e.jsx(y,{disabled:!0,value:`${se??"?"} BTS`,label:"fees",readOnly:!0}),e.jsx(C,{children:r("CreditOffer:cardContent.networkFeeDescription")}),c&&c.id===c.referrer?e.jsx(O,{children:r("CreditOffer:cardContent.ltmRebate",{rebate:.8*se})}):null]})})]})})})})}),e.jsx(le,{children:n&&!n.holding||n&&n.holding&&n.amount<M?e.jsx(Z,{disabled:!0,children:r("CreditOffer:cardContent.submit")}):e.jsx(Z,{onClick:()=>G(!0),children:r("CreditOffer:cardContent.submit")})})]})]}),De?e.jsx(Ue,{operationName:"credit_offer_accept",username:c.username,usrChain:c.chain,userID:c.id,dismissCallback:G,headerText:r("CreditOffer:dialogContent.borrowing",{finalBorrowAmount:u,symbol:i.symbol,owner_name:s.owner_name,owner_account:s.owner_account}),trxJSON:[{borrower:c.id,offer_id:s.id,borrow_amount:{amount:ue(u,i.precision),asset_id:i.id},collateral:{amount:ue(M,n.precision),asset_id:n.id},max_fee_rate:s.fee_rate,min_duration_seconds:s.max_duration_seconds,extensions:{auto_repay:Te??0}}]},`Borrowing${u}${i.symbol}from${s.owner_name}(${s.owner_account})`):null,e.jsx("div",{className:"grid grid-cols-1 mt-5",children:e.jsxs(K,{children:[e.jsx(Q,{children:e.jsx(W,{children:r("CreditOffer:risks.risksTitle")})}),e.jsxs(X,{className:"text-sm",children:[r("CreditOffer:risks.risksDescription"),e.jsxs("ul",{className:"ml-2 list-disc [&>li]:mt-2 pl-2",children:[e.jsx("li",{children:r("CreditOffer:risks.riskCollateral")}),e.jsx("li",{children:r("CreditOffer:risks.riskLiquidity")}),e.jsx("li",{children:r("CreditOffer:risks.riskPlatform")}),e.jsx("li",{children:r("CreditOffer:risks.riskUser")}),e.jsx("li",{children:r("CreditOffer:risks.riskNetwork")})]})]}),e.jsx(le,{className:"text-sm",children:r("CreditOffer:risks.risksFooter")})]})})]})})}export{xr as default};
